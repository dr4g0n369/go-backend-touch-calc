<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
<META http-equiv="Content-Type" content="text/html; charset=UTF-8">
<title>TouchCalc - {{.fname}}</title>

<!-- SocialCalc JS files - load order matters! Constants must come first -->
<script type="text/javascript" src="/static/js/socialcalcconstants.js"></script>
<script type="text/javascript" src="/static/js/socialcalc-3.js"></script>
<script type="text/javascript" src="/static/js/socialcalctouch.js"></script>
<script type="text/javascript" src="/static/js/socialcalctableeditor.js"></script>
<script type="text/javascript" src="/static/js/formatnumber2.js"></script>
<script type="text/javascript" src="/static/js/formula1.js"></script>
<script type="text/javascript" src="/static/js/socialcalcpopup.js"></script>
<script type="text/javascript" src="/static/js/socialcalcspreadsheetcontrol.js"></script>
<script type="text/javascript" src="/static/js/socialcalcworkbook.js"></script>
<script type="text/javascript" src="/static/js/socialcalcworkbookcontrol.js"></script>
<script type="text/javascript" src="/static/js/socialcalcimages.js"></script>

<script type="text/javascript" src="/static/js/json2.js"></script>
<script src="/static/js/jquery.min.js" type="text/javascript"></script>

<style>
body, td, input, textarea {font-family:verdana,helvetica,sans-serif;font-size:small;}
.smaller {font-size:smaller;}
</style>
</head>

<body style="background-color:#FFF;" onresize="spreadsheet.DoOnResize();">

<h3><a href="/">TouchCalc</a>&nbsp;&nbsp;&nbsp;Editing
<span id="filenameholder">{{.fname}}</span>
&nbsp;&nbsp;
<span style="font-size:smaller;">User: {{.user}}</span>
</h3>

<div id="workbookControl" style="background-color:#80A9F3;">
</div>

<div style="margin:8px 0px 10px 0px;">
 <div id="tableeditor" style="margin:8px 0px 10px 0px;">Loading editor</div>
</div>
 <div id="msg" onclick="this.innerHTML='&nbsp;';"></div>

<textarea name="savestr" id="sheetdata" style="display:none;">
{{.sheetstr}}
</textarea>

<script>

var sheetnamemscedata = "{{.sheetmscestr}}";

SocialCalc.Constants.defaultImagePrefix = "/static/images/sc-";
SocialCalc.Popup.imagePrefix = "/static/images/sc-";

var spreadsheet = new SocialCalc.SpreadsheetControl();

// setup tabs - remove default extras
spreadsheet.tabs.splice(spreadsheet.tabnums.sort, 5);

spreadsheet.tabnums = {};
for (var i=0; i<spreadsheet.tabs.length; i++) {
    spreadsheet.tabnums[spreadsheet.tabs[i].name] = i;
}

// Import tab
spreadsheet.tabnums["import"] = spreadsheet.tabs.length;
spreadsheet.tabs.push({name: "import", text: "Import", html:
    '<div id="%id.importtools" style="display:none;">'+
    '<form id="uploadfile" action="/import" method="post" enctype="multipart/form-data" onsubmit="return uploadcheck()" name="uploadfile">'+
    '<table cellspacing="0" cellpadding="0" style="background-color:#FFF;"><tr><td>'+
    '<input type="file" id="fileUpload" name="upload">'+
    '</td>'+
    '<td style="vertical-align:top;padding-right:6px;">'+
    '<input type="submit" value="Import">'+
    '<input type="text" id="ext" name="ext" readonly="readonly" style="display:none;">'+
    '</td></tr></table></form></div>',
    onclickFocus: true
});

// Export tab
spreadsheet.tabnums["export"] = spreadsheet.tabs.length;
spreadsheet.tabs.push({name: "export", text: "Export", html:
    '<div id="%id.exporttools" style="display:none">'+
    '<form id="downloadfile" action="/downloadfile" method="post" enctype="multipart/form-data" onsubmit="return downloadcheck()">'+
    '<table cellspacing="0" cellpadding="0"><tr><td>'+
    '<select id="downloadtype" name="type">'+
    '<option value="MSCE">MSCE</option>'+
    '<option value="MSC">MSC</option>'+
    '<option value="CSV">CSV</option>'+
    '<option value="HTML">HTML</option>'+
    '</select>'+
    '</td>'+
    '<td style="vertical-align:top;padding-right:6px;">'+
    '<input type="submit" value="Export">'+
    '<input type="text" id="downloadcontent" name="content" style="display:none;">'+
    '</td></tr></table></form></div>',
    onclickFocus: true
});

// Save tab
spreadsheet.tabnums["saveas"] = spreadsheet.tabs.length;
spreadsheet.tabs.push({name: "saveas", text: "Save", html:
    '<div id="%id.saveastools" style="display:none">'+
    '<form id="saveas" action="/save" method="post" onsubmit="return savecheck()">'+
    '<table cellspacing="0" cellpadding="0"><tr><td>'+
    '<input type="text" id="saveasentry" value="{{.fname}}" onfocus="SocialCalc.CmdGotFocus(this);">'+
    '</td>'+
    '<td style="vertical-align:top;padding-right:6px;">'+
    '<input type="submit" value="SaveAs">'+
    '</td></tr></table></form></div>',
    onclickFocus: true
});

var workbook = new SocialCalc.WorkBook(spreadsheet);
workbook.InitializeWorkBook("sheet1");

spreadsheet.InitializeSpreadsheetControl("tableeditor");
spreadsheet.ExecuteCommand('redisplay', '');

var workbookcontrol = new SocialCalc.WorkBookControl(workbook, "workbookControl", "sheet1");
workbookcontrol.InitializeWorkBookControl();

var fname = '{{.fname}}';

function MyEndsWith(str, suffix) {
    return str.indexOf(suffix, str.length - suffix.length) !== -1;
}

if (MyEndsWith(fname, ".msce") || MyEndsWith(fname, ".MSCE")) {
    SocialCalc.WorkBookControlLoad(decodeURIComponent(sheetnamemscedata));
} else {
    SocialCalc.WorkBookControlLoad(document.getElementById("sheetdata").value);
}

spreadsheet.DoOnResize();

// Save function
function savecheck() {
    var savefname = document.getElementById('saveasentry').value;
    if (savefname == '') { alert('Empty file name'); return false; }

    var message = {};
    message.fname = savefname;
    message.data = SocialCalc.WorkBookControlSaveSheet();

    $.ajax({
        url: '/save',
        type: 'POST',
        data: message,
        success: function(response) {
            if (response && response.data) {
                alert(response.data);
            } else {
                alert("Saved successfully");
            }
        },
        error: function() {
            alert("Error saving file");
        }
    });

    return false;
}

function uploadcheck() {
    var file = document.getElementById('fileUpload').value;
    if (file == "") {
        alert("You must select a file to upload");
        return false;
    }
    return true;
}

function downloadcheck() {
    var ele = document.getElementById('downloadtype');
    if (ele.selectedIndex == -1) {
        alert("Please select type for download file");
        return false;
    }
    if (ele.options[ele.selectedIndex].value == "MSCE") {
        document.getElementById('downloadcontent').value = encodeURIComponent(SocialCalc.WorkBookControlSaveSheet());
    } else if (ele.options[ele.selectedIndex].value == "HTML") {
        var control = SocialCalc.GetCurrentWorkBookControl();
        var html = control.workbook.spreadsheet.CreateSheetHTML();
        document.getElementById('downloadcontent').value = html;
    } else {
        document.getElementById('downloadcontent').value = SocialCalc.WorkBookControlSaveSheet();
    }
    return true;
}

// Auto-save every 60 seconds
var autoSaveTimer = setInterval(function() {
    if (fname && fname !== '') {
        var message = {};
        message.fname = fname;
        message.data = SocialCalc.WorkBookControlSaveSheet();
        $.ajax({
            url: '/save',
            type: 'POST',
            data: message,
            success: function(response) {
                var msgEl = document.getElementById('msg');
                if (msgEl) msgEl.innerHTML = 'Auto-saved at ' + new Date().toLocaleTimeString();
            },
            error: function() {
                var msgEl = document.getElementById('msg');
                if (msgEl) msgEl.innerHTML = 'Auto-save failed';
            }
        });
    }
}, 60000);

</script>

</body>
</html>
